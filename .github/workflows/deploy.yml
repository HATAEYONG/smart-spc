name: Deploy to AWS Lightsail

on:
  push:
    branches:
      - main
      - production
  pull_request:
    branches:
      - main
      - production
  workflow_dispatch:  # Manual trigger

env:
  PYTHON_VERSION: '3.10'
  NODE_VERSION: '18'

jobs:
  # =========================================================================
  # JOB 1: Code Quality Checks
  # =========================================================================
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          cd backend
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 black isort pylint

      - name: Run Black (Code Formatting)
        run: |
          cd backend
          black --check --diff apps/

      - name: Run isort (Import Sorting)
        run: |
          cd backend
          isort --check-only --diff apps/

      - name: Run Flake8 (Linting)
        run: |
          cd backend
          flake8 apps/ --max-line-length=120 --exclude=migrations,__pycache__

      - name: Run Pylint (Static Analysis)
        run: |
          cd backend
          pylint apps/ --disable=C0111,R0903,C0103 --max-line-length=120
        continue-on-error: true

  # =========================================================================
  # JOB 2: Security Scan
  # =========================================================================
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          cd backend
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install safety bandit

      - name: Run Safety (Dependency Vulnerability Check)
        run: |
          cd backend
          safety check --json || true

      - name: Run Bandit (Security Issues)
        run: |
          cd backend
          bandit -r apps/ -f json -o bandit-report.json || true

      - name: Upload Bandit Report
        uses: actions/upload-artifact@v3
        with:
          name: bandit-security-report
          path: backend/bandit-report.json
        if: always()

  # =========================================================================
  # JOB 3: Run Tests
  # =========================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_DB: test_aps_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}

      - name: Install dependencies
        run: |
          cd backend
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-django pytest-cov

      - name: Create test environment file
        run: |
          cd backend
          cat > .env.test <<EOF
          SECRET_KEY=test-secret-key-for-ci
          DEBUG=True
          DB_ENGINE=django.db.backends.postgresql
          DB_NAME=test_aps_db
          DB_USER=test_user
          DB_PASSWORD=test_password
          DB_HOST=localhost
          DB_PORT=5432
          EOF

      - name: Run migrations
        run: |
          cd backend
          export DJANGO_SETTINGS_MODULE=config.settings
          python manage.py migrate --noinput

      - name: Run Django tests
        run: |
          cd backend
          python manage.py test apps.aps.tests apps.erp.tests --verbosity=2

      - name: Run GA Engine tests
        run: |
          cd backend
          python -m pytest apps/aps/tests/test_ga_engine.py -v

      - name: Generate coverage report
        run: |
          cd backend
          pytest --cov=apps --cov-report=xml --cov-report=html
        continue-on-error: true

      - name: Upload coverage report
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: backend/htmlcov/
        if: always()

  # =========================================================================
  # JOB 4: Build & Deploy to Lightsail
  # =========================================================================
  deploy:
    name: Deploy to AWS Lightsail
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan, test]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/production'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          known_hosts: ${{ secrets.KNOWN_HOSTS }}

      - name: Add Lightsail IP to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.LIGHTSAIL_IP }} >> ~/.ssh/known_hosts

      - name: Create deployment package
        run: |
          tar -czf deployment.tar.gz \
            --exclude='.git' \
            --exclude='backend/venv' \
            --exclude='backend/__pycache__' \
            --exclude='backend/**/__pycache__' \
            --exclude='backend/staticfiles' \
            --exclude='backend/media' \
            --exclude='node_modules' \
            .

      - name: Upload to Lightsail
        run: |
          scp deployment.tar.gz ubuntu@${{ secrets.LIGHTSAIL_IP }}:/tmp/

      - name: Deploy on Lightsail
        run: |
          ssh ubuntu@${{ secrets.LIGHTSAIL_IP }} << 'EOF'
            set -e

            # Extract deployment package
            cd /var/www/aps
            sudo tar -xzf /tmp/deployment.tar.gz
            rm /tmp/deployment.tar.gz

            # Set ownership
            sudo chown -R ubuntu:ubuntu /var/www/aps

            # Activate virtual environment
            source backend/venv/bin/activate

            # Install/update dependencies
            cd backend
            pip install --upgrade pip
            pip install -r requirements.txt

            # Run migrations
            python manage.py migrate --noinput

            # Collect static files
            python manage.py collectstatic --noinput

            # Restart services
            sudo systemctl restart aps-gunicorn
            sudo systemctl reload nginx

            # Health check
            sleep 5
            curl -f http://localhost/health/ || exit 1

            echo "Deployment successful!"
          EOF

      - name: Verify deployment
        run: |
          # Wait for service to stabilize
          sleep 10

          # Check health endpoint
          curl -f https://${{ secrets.LIGHTSAIL_DOMAIN }}/health/ || exit 1

          echo "Deployment verified successfully!"

      - name: Notify deployment success
        if: success()
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "✅ Deployment to AWS Lightsail successful!",
              "attachments": [{
                "color": "good",
                "fields": [
                  {"title": "Branch", "value": "${{ github.ref_name }}", "short": true},
                  {"title": "Commit", "value": "${{ github.sha }}", "short": true},
                  {"title": "Author", "value": "${{ github.actor }}", "short": true}
                ]
              }]
            }' || true

      - name: Notify deployment failure
        if: failure()
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK }} \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "❌ Deployment to AWS Lightsail failed!",
              "attachments": [{
                "color": "danger",
                "fields": [
                  {"title": "Branch", "value": "${{ github.ref_name }}", "short": true},
                  {"title": "Commit", "value": "${{ github.sha }}", "short": true},
                  {"title": "Author", "value": "${{ github.actor }}", "short": true}
                ]
              }]
            }' || true

  # =========================================================================
  # JOB 5: Post-Deployment Tests
  # =========================================================================
  post-deployment-test:
    name: Post-Deployment Tests
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/production'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Run smoke tests
        run: |
          # Test main endpoints
          curl -f https://${{ secrets.LIGHTSAIL_DOMAIN }}/ || exit 1
          curl -f https://${{ secrets.LIGHTSAIL_DOMAIN }}/health/ || exit 1
          curl -f https://${{ secrets.LIGHTSAIL_DOMAIN }}/api/ || exit 1

          echo "Smoke tests passed!"

      - name: Test SSL certificate
        run: |
          echo | openssl s_client -connect ${{ secrets.LIGHTSAIL_DOMAIN }}:443 \
            -servername ${{ secrets.LIGHTSAIL_DOMAIN }} 2>/dev/null | \
            openssl x509 -noout -dates

      - name: Run post-deployment verification
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.LIGHTSAIL_IP }}
          username: ubuntu
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          script: |
            cd /var/www/aps
            sudo bash deploy/post_deployment_verification.sh
